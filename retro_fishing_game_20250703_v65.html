<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retro Fishing Quest</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        :root {
            --font-size-base: 10px;
            --font-size-title: 24px;
            --font-size-header: 16px;
            --font-size-small: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: #ecf0f1;
            min-height: 100vh;
            image-rendering: pixelated;
            overflow-x: hidden;
            touch-action: manipulation;
            font-size: var(--font-size-base);
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border: 3px solid #f39c12;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }
        
        .title {
            font-size: var(--font-size-title);
            color: #f39c12;
            text-shadow: 2px 2px 0px #000;
            margin-bottom: 10px;
        }
        
        .stats-bar {
            display: flex;
            justify-content: space-around;
            background: rgba(52, 73, 94, 0.9);
            padding: 10px;
            border: 2px solid #34495e;
            margin-bottom: 20px;
            font-size: var(--font-size-small);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        .location-area {
            background: rgba(0,0,0,0.8);
            border: 3px solid #2980b9;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .location-overlay {
            background: rgba(0,0,0,0.7);
            border-radius: 8px;
            padding: 20px;
            height: 100%;
        }
        
        .fishing-bg {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
                              url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600"><defs><linearGradient id="water" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%233498db;stop-opacity:1" /><stop offset="50%" style="stop-color:%232980b9;stop-opacity:1" /><stop offset="100%" style="stop-color:%231e3a8a;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23water)" width="1000" height="400"/><rect fill="%232c5530" y="380" width="1000" height="220"/><circle fill="%23f1c40f" cx="850" cy="120" r="50"/><path fill="%2327ae60" d="M0,350 Q200,320 400,350 Q600,380 800,350 Q900,335 1000,350 L1000,400 L0,400 Z"/><g fill="%23fff" opacity="0.3"><circle cx="300" cy="200" r="2"/><circle cx="450" cy="150" r="1.5"/><circle cx="600" cy="180" r="2.5"/><circle cx="750" cy="220" r="1"/></g><path fill="%23654321" d="M50,350 L150,350 L140,600 L60,600 Z"/></svg>');
        }
        
        .home-bg {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
                              url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600"><rect fill="%2387CEEB" width="1000" height="400"/><rect fill="%2327ae60" y="350" width="1000" height="250"/><rect fill="%23cd853f" x="250" y="200" width="500" height="350"/><polygon fill="%238b4513" points="200,200 800,200 500,80"/><rect fill="%23deb887" x="470" y="400" width="60" height="150"/><rect fill="%236495ed" x="320" y="280" width="60" height="60"/><rect fill="%236495ed" x="620" y="280" width="60" height="60"/><circle fill="%23ffff00" cx="900" cy="100" r="40"/><g fill="%23228b22"><circle cx="150" cy="450" r="30"/><circle cx="850" cy="480" r="25"/><circle cx="100" cy="500" r="20"/></g><rect fill="%23ff6347" x="330" y="290" width="50" height="50"/></svg>');
        }
        
        .port-bg {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
                              url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600"><defs><linearGradient id="sea" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%2320b2aa;stop-opacity:1" /><stop offset="100%" style="stop-color:%23008b8b;stop-opacity:1" /></linearGradient></defs><rect fill="url(%23sea)" width="1000" height="350"/><rect fill="%23cd853f" y="320" width="1000" height="280"/><rect fill="%23696969" x="100" y="250" width="150" height="120"/><rect fill="%23696969" x="750" y="280" width="180" height="90"/><polygon fill="%23fff" points="130,150 180,150 155,120"/><polygon fill="%23fff" points="780,180 830,180 805,150"/><rect fill="%23654321" x="120" y="150" width="5" height="100"/><rect fill="%23654321" x="800" y="180" width="5" height="90"/><g fill="%23ff0000"><rect x="135" y="125" width="15" height="10"/><rect x="810" y="155" width="15" height="10"/></g><path fill="%23daa520" d="M0,320 Q250,300 500,320 Q750,340 1000,320 L1000,350 L0,350 Z"/><g fill="%23fff" opacity="0.4"><circle cx="200" cy="180" r="1.5"/><circle cx="400" cy="200" r="2"/><circle cx="600" cy="160" r="1"/></g></svg>');
        }
        
        .kitchen-bg {
            background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), 
                              url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600"><rect fill="%23f5f5dc" width="1000" height="600"/><rect fill="%23deb887" y="500" width="1000" height="100"/><rect fill="%23696969" x="100" y="200" width="400" height="200"/><circle fill="%23ff4500" cx="200" cy="250" r="20"/><circle fill="%23ff4500" cx="300" cy="250" r="20"/><circle fill="%23ff4500" cx="400" cy="250" r="20"/><rect fill="%23dcdcdc" x="120" y="270" width="360" height="20"/><rect fill="%23cd853f" x="600" y="150" width="300" height="250"/><rect fill="%23deb887" x="610" y="200" width="280" height="180"/><g fill="%23fff"><rect x="650" y="220" width="50" height="80"/><rect x="750" y="220" width="50" height="80"/><rect x="850" y="220" width="40" height="60"/></g><rect fill="%23ff6347" x="200" y="320" width="80" height="60"/><circle fill="%23ffff00" cx="750" cy="100" r="30"/></svg>');
        }
        
        .navigation {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .nav-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            border: none;
            color: white;
            padding: 12px 20px;
            font-family: inherit;
            font-size: var(--font-size-small);
            border: 2px solid #fff;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
            text-transform: uppercase;
            min-height: 44px;
        }
        
        .nav-btn:hover {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .nav-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border: none;
            color: white;
            padding: 12px 20px;
            font-family: inherit;
            font-size: var(--font-size-small);
            border: 2px solid #fff;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.2s;
            text-transform: uppercase;
            min-height: 44px;
        }
        
        .btn:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
        }
        
        .btn-large {
            padding: 20px 30px;
            font-size: calc(var(--font-size-base) + 2px);
            margin: 10px;
            min-width: 200px;
            min-height: 80px;
        }
        
        .home-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .sidebar {
            background: rgba(0,0,0,0.8);
            border: 3px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            height: fit-content;
        }
        
        .sidebar-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 15px;
        }
        
        .sidebar-title {
            color: #27ae60;
            font-size: calc(var(--font-size-base) + 2px);
            margin-bottom: 10px;
            text-align: center;
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .inventory-slot {
            aspect-ratio: 1;
            border: 2px solid #34495e;
            background: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-size-small);
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px;
        }
        
        .inventory-slot:hover {
            border-color: #f39c12;
        }
        
        .inventory-slot.occupied {
            border-color: #27ae60;
            background: #1e8449;
        }
        
        .rarity-common { border-color: #95a5a6; }
        .rarity-uncommon { border-color: #3498db; }
        .rarity-rare { border-color: #9b59b6; }
        .rarity-epic { border-color: #f39c12; }
        .rarity-legendary { border-color: #e74c3c; }
        
        .equipment-section {
            background: rgba(0,0,0,0.8);
            border: 3px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            position: relative;
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 400"><defs><linearGradient id="rod" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:%23654321;stop-opacity:0.3" /><stop offset="100%" style="stop-color:%23321;" /></linearGradient></defs><g opacity="0.2"><path stroke="%23654321" stroke-width="8" fill="none" d="M150,380 L150,40 Q150,20 140,15"/><circle cx="150" cy="35" r="5" fill="%23654321"/><path stroke="%23333" stroke-width="2" fill="none" d="M150,100 Q180,120 200,150 Q210,170 205,200 Q200,230 180,250"/><circle cx="205" cy="200" r="3" fill="%23333"/></g></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .equipment-slot {
            background: rgba(52, 73, 94, 0.9);
            border: 2px solid #7f8c8d;
            padding: 8px;
            margin: 8px 0;
            border-radius: 4px;
            font-size: var(--font-size-small);
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            backdrop-filter: blur(2px);
            transition: all 0.3s ease;
        }
        
        .equipment-slot:hover {
            background: rgba(52, 73, 94, 1);
            border-color: #f39c12;
            transform: scale(1.02);
        }
        
        .equipment-slot.equipped {
            border-color: #27ae60;
            background: rgba(30, 132, 73, 0.9);
            box-shadow: 0 0 10px rgba(39, 174, 96, 0.3);
        }
        
        .rod-slot {
            position: relative;
            z-index: 2;
            margin-top: 20px;
        }
        
        .line-slot {
            position: relative;
            z-index: 2;
            margin-top: 40px;
        }
        
        .hook-slot {
            position: relative;
            z-index: 2;
            margin-top: 60px;
        }
        
        .bait-slot {
            position: relative;
            z-index: 2;
            margin-top: 20px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #2c3e50;
            border: 3px solid #f39c12;
            border-radius: 8px;
            padding: 20px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        
        .card {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            border: 2px solid;
            border-radius: 8px;
            padding: 10px;
            margin: 10px;
            text-align: center;
            min-width: 120px;
            display: inline-block;
        }
        
        .fishing-result {
            background: rgba(46, 204, 113, 0.2);
            border: 2px solid #2ecc71;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-bar {
            background: #34495e;
            border: 2px solid #7f8c8d;
            border-radius: 10px;
            overflow: hidden;
            height: 25px;
            margin: 5px 0;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #e74c3c, #f39c12);
            height: 100%;
            transition: width 0.1s ease, background 0.5s ease;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        #fishing-progress {
            background: rgba(0,0,0,0.6);
            border-radius: 8px;
            padding: 15px;
            margin: 10px auto;
            max-width: 400px;
            border: 2px solid #3498db;
        }
        
        #fishing-phase-text {
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            animation: pulse-text 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-text {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        #fishing-status {
            display: flex;
            justify-content: space-between;
            background: rgba(52, 73, 94, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #7f8c8d;
        }
        
        #fishing-timer {
            color: #2ecc71;
            font-weight: bold;
        }
        
        #fishing-chance {
            color: #f39c12;
            font-weight: bold;
        }
        
        .save-code {
            background: #34495e;
            border: 2px solid #f39c12;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            color: #f39c12;
            word-break: break-all;
            margin: 10px 0;
        }
        
        .input-field {
            background: #2c3e50;
            border: 2px solid #34495e;
            color: #fff;
            padding: 10px;
            font-family: monospace;
            border-radius: 4px;
            width: 100%;
            margin: 5px 0;
        }
        
        .achievement {
            background: rgba(241, 196, 15, 0.2);
            border: 2px solid #f1c40f;
            border-radius: 4px;
            padding: 5px;
            margin: 2px 0;
            font-size: var(--font-size-small);
            animation: pulse 1s ease-in-out;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .options-menu {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 999;
        }
        
        .options-btn {
            background: #34495e;
            border: 2px solid #7f8c8d;
            color: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 20px;
        }
        
        .font-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .achievement-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .achievement-item {
            background: #34495e;
            border: 2px solid #27ae60;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            font-size: var(--font-size-small);
        }
        
        .achievement-item.locked {
            border-color: #7f8c8d;
            background: #2c3e50;
            opacity: 0.6;
        }
        
        /* Mobile Responsive */
        @media screen and (max-width: 768px) {
            .main-content {
                display: block;
                gap: 15px;
            }
            
            .location-area {
                margin-bottom: 15px;
                padding: 15px;
                min-height: auto;
            }
            
            .inventory-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
            }
            
            .home-buttons {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .nav-btn, .btn {
                min-width: 100px;
                padding: 15px 20px;
            }
            
            .stats-bar {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .stat {
                flex: 1;
                min-width: calc(33% - 5px);
            }
            
            /* CORREZIONE MOBILE - Barra Pesca */
            #fishing-progress {
                max-width: 100%;
                margin: 15px 0;
                padding: 15px;
                border: 2px solid #3498db;
            }
            
            .progress-bar {
                height: 35px;
                margin: 10px 0;
            }
            
            #fishing-phase-text {
                font-size: 12px;
                margin-bottom: 10px;
            }
            
            #fishing-status {
                font-size: 9px;
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
            
            /* CORREZIONE MOBILE - Modal e Textarea */
            .modal-content {
                margin: 10px;
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 20px);
                padding: 15px;
            }
            
            .input-field {
                font-size: 11px;
                padding: 12px;
                min-height: 120px;
            }
            
            textarea.input-field {
                min-height: 150px;
                resize: vertical;
            }
        }
        
        @media screen and (max-width: 480px) {
            .inventory-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .btn-large {
                min-width: 150px;
                padding: 15px 20px;
                font-size: var(--font-size-base);
            }
        }
    </style>
</head>
<body>
    <div class="options-menu">
        <button class="options-btn" onclick="toggleOptions()">‚öôÔ∏è</button>
    </div>

    <div class="game-container">
        <div class="header">
            <div class="title">üé£ RETRO FISHING QUEST üé£</div>
            <div>Un'avventura di pesca nostalgica</div>
        </div>
        
        <div class="stats-bar">
            <div class="stat">
                <div>LIVELLO</div>
                <div class="stat-value" id="player-level">1</div>
            </div>
            <div class="stat">
                <div>EXP</div>
                <div class="stat-value" id="player-exp">0/100</div>
            </div>
            <div class="stat">
                <div>MONETE</div>
                <div class="stat-value" id="player-coins">50</div>
            </div>
            <div class="stat">
                <div>ENERGIA</div>
                <div class="stat-value" id="player-energy">100/100</div>
            </div>
            <div class="stat">
                <div>PESO</div>
                <div class="stat-value" id="player-weight">0/50</div>
            </div>
            <div class="stat">
                <div>FORZA</div>
                <div class="stat-value" id="player-strength">5</div>
            </div>
            <div class="stat">
                <div>FORTUNA</div>
                <div class="stat-value" id="player-luck">5</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="location-area" id="location-area">
                <div class="location-overlay" id="location-content">
                    <!-- Contenuto dinamico delle location -->
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title" id="inventory-title">üíº INVENTARIO (0/20)</div>
                    <div class="inventory-grid" id="inventory-grid"></div>
                    <button class="btn btn-secondary" onclick="openShop()">üõí NEGOZIO</button>
                </div>
                
                <div class="sidebar-section equipment-section">
                    <div class="sidebar-title">üé£ EQUIPAGGIAMENTO</div>
                    <div class="equipment-slot rod-slot" id="rod-slot">
                        <div>Canna: Semplice</div>
                    </div>
                    <div class="equipment-slot line-slot" id="line-slot">
                        <div>Lenza: Base</div>
                    </div>
                    <div class="equipment-slot hook-slot" id="hook-slot">
                        <div>Amo: Piccolo</div>
                    </div>
                    <div class="equipment-slot bait-slot" id="bait-slot">
                        <div>Esca: Nessuna</div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-title">üíæ SALVATAGGIO</div>
                    <button class="btn" onclick="generateSaveCode()">Genera Codice</button>
                    <button class="btn" onclick="loadGame()">Carica Partita</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal per le opzioni -->
    <div class="modal" id="options-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('options-modal')">&times;</button>
            <h3>‚öôÔ∏è OPZIONI</h3>
            <div class="font-controls">
                <span>Font Size:</span>
                <button class="btn" onclick="changeFontSize(-1)">-</button>
                <span id="font-size-display">Normale</span>
                <button class="btn" onclick="changeFontSize(1)">+</button>
            </div>
            <div style="margin-top: 20px; border-top: 1px solid #7f8c8d; padding-top: 15px;">
                <button class="btn" onclick="confirmNewGame()" style="background: linear-gradient(45deg, #e74c3c, #c0392b);">
                    üÜï NUOVA PARTITA
                </button>
                <p style="font-size: 8px; color: #bdc3c7; margin-top: 8px;">
                    ‚ö†Ô∏è Canceller√† tutti i progressi attuali
                </p>
            </div>
        </div>
    </div>
    
    <!-- Modal per il negozio -->
    <div class="modal" id="shop-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('shop-modal')">&times;</button>
            <h3>üõí NEGOZIO DI CARTE</h3>
            <div class="card-pack" onclick="buyCardPack()" style="background: linear-gradient(45deg, #8e44ad, #9b59b6); border: 3px solid #fff; border-radius: 8px; padding: 15px; text-align: center; margin: 10px 0; cursor: pointer; transition: all 0.3s;">
                <h4>üì¶ PACCHETTO BASE</h4>
                <p>5 carte casuali</p>
                <p>Costo: 20 monete</p>
            </div>
        </div>
    </div>
    
    <!-- Modal per statistiche carte -->
    <div class="modal" id="card-stats-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('card-stats-modal')">&times;</button>
            <h3 id="card-stats-title">üìä STATISTICHE CARTA</h3>
            <div id="card-stats-content"></div>
            <div style="margin-top: 20px;">
                <button class="btn" id="sell-card-btn" onclick="sellSelectedCard()">üí∞ VENDI</button>
                <button class="btn btn-secondary" onclick="closeModal('card-stats-modal')">‚ùå CHIUDI</button>
            </div>
        </div>
    </div>
    
    <!-- Altri modal... -->
    <div class="modal" id="pack-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('pack-modal')">&times;</button>
            <h3>üì¶ APERTURA PACCHETTO</h3>
            <div id="pack-contents"></div>
        </div>
    </div>
    
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('save-modal')">&times;</button>
            <h3>üíæ CODICE DI SALVATAGGIO</h3>
            <p>Salva questo codice per recuperare la tua partita:</p>
            <div class="save-code" id="save-code-display"></div>
            <button class="btn" onclick="copySaveCode()">Copia Codice</button>
        </div>
    </div>
    
    <div class="modal" id="load-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('load-modal')">&times;</button>
            <h3>üìÇ CARICA PARTITA</h3>
            <p>Inserisci il tuo codice di salvataggio:</p>
            <input type="text" class="input-field" id="load-code-input" placeholder="Inserisci codice esadecimale...">
            <button class="btn" onclick="loadFromCode()">Carica</button>
        </div>
    </div>
    
    <div class="modal" id="achievements-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('achievements-modal')">&times;</button>
            <h3>üèÜ ACHIEVEMENTS</h3>
            <div class="achievement-list" id="achievements-list"></div>
        </div>
    </div>
    
    <!-- Modal conferma nuova partita -->
    <div class="modal" id="new-game-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('new-game-modal')">&times;</button>
            <h3>üÜï NUOVA PARTITA</h3>
            <div style="text-align: center; padding: 20px;">
                <p style="margin-bottom: 20px; color: #f39c12;">
                    ‚ö†Ô∏è Sei sicuro di voler iniziare una nuova partita?
                </p>
                <p style="margin-bottom: 20px; font-size: 10px; color: #bdc3c7;">
                    Tutti i tuoi progressi attuali verranno persi definitivamente:
                </p>
                <div style="background: #34495e; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
                    <p style="font-size: 9px; margin: 5px 0;">‚Ä¢ Livello ${gameState.player.level} e ${gameState.player.exp} EXP</p>
                    <p style="font-size: 9px; margin: 5px 0;">‚Ä¢ ${gameState.player.coins} monete</p>
                    <p style="font-size: 9px; margin: 5px 0;">‚Ä¢ Inventario e equipaggiamento</p>
                    <p style="font-size: 9px; margin: 5px 0;">‚Ä¢ ${gameState.achievements.length} achievement sbloccati</p>
                </div>
                <div style="margin-top: 25px;">
                    <button class="btn" onclick="startNewGame()" style="background: linear-gradient(45deg, #e74c3c, #c0392b); margin-right: 10px;">
                        ‚úÖ S√å, RICOMINCIA
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('new-game-modal')">
                        ‚ùå ANNULLA
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Stato del gioco
        let gameState = {
            player: {
                level: 1,
                exp: 0,
                expToNext: 100,
                coins: 50,
                energy: 100,
                maxEnergy: 100,
                strength: 5,
                luck: 5,
                maxWeight: 50,
                currentWeight: 0,
                canLevelUp: false
            },
            inventory: [],
            equipment: {
                rod: { name: "Canna Semplice", type: "rod", power: 1, rarity: "common", weight: 5, value: 10, icon: "üé£" },
                line: { name: "Lenza Base", type: "line", power: 1, rarity: "common", weight: 1, value: 5, icon: "üßµ" },
                hook: { name: "Amo Piccolo", type: "hook", power: 1, rarity: "common", weight: 1, value: 3, icon: "üìé" },
                bait: null
            },
            currentLocation: 'fishing',
            gameId: generateGameId(),
            achievements: [],
            isFishing: false,
            fontSizeLevel: 0 // -2, -1, 0, 1, 2
        };
        
        // Rileva se siamo su mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        
        // Feedback vibrazione per mobile
        function vibrate(duration = 50) {
            if (isMobile && navigator.vibrate) {
                navigator.vibrate(duration);
            }
        }
        
        // Database degli oggetti con icone
        const itemDatabase = {
            // Canne da pesca
            "basic_rod": { 
                name: "Canna Semplice", type: "rod", subtype: "Equipaggiamento", 
                power: 1, rarity: "common", reqLevel: 1, weight: 5, value: 10,
                icon: "üé£"
            },
            "sturdy_rod": { 
                name: "Canna Robusta", type: "rod", subtype: "Equipaggiamento", 
                power: 3, rarity: "uncommon", reqLevel: 5, weight: 8, value: 50,
                icon: "ü™ù"
            },
            "pro_rod": { 
                name: "Canna Pro", type: "rod", subtype: "Equipaggiamento", 
                power: 6, rarity: "rare", reqLevel: 10, weight: 10, value: 150,
                icon: "üéØ"
            },
            "master_rod": { 
                name: "Canna Maestro", type: "rod", subtype: "Equipaggiamento", 
                power: 10, rarity: "epic", reqLevel: 20, weight: 12, value: 400,
                icon: "‚ö°"
            },
            "legendary_rod": { 
                name: "Canna Leggendaria", type: "rod", subtype: "Equipaggiamento", 
                power: 15, rarity: "legendary", reqLevel: 25, weight: 15, value: 1000,
                icon: "üëë"
            },
            
            // Lenze
            "basic_line": { 
                name: "Lenza Base", type: "line", subtype: "Componente da pesca", 
                power: 1, rarity: "common", reqLevel: 1, weight: 1, value: 5,
                icon: "üßµ"
            },
            "strong_line": { 
                name: "Lenza Forte", type: "line", subtype: "Componente da pesca", 
                power: 3, rarity: "uncommon", reqLevel: 3, weight: 2, value: 20,
                icon: "ü™¢"
            },
            "steel_line": { 
                name: "Lenza Acciaio", type: "line", subtype: "Componente da pesca", 
                power: 6, rarity: "rare", reqLevel: 8, weight: 3, value: 75,
                icon: "‚öôÔ∏è"
            },
            "titanium_line": { 
                name: "Lenza Titanio", type: "line", subtype: "Componente da pesca", 
                power: 10, rarity: "epic", reqLevel: 15, weight: 4, value: 200,
                icon: "üîó"
            },
            "magic_line": { 
                name: "Lenza Magica", type: "line", subtype: "Componente da pesca", 
                power: 15, rarity: "legendary", reqLevel: 22, weight: 5, value: 500,
                icon: "‚ú®"
            },
            
            // Ami
            "small_hook": { 
                name: "Amo Piccolo", type: "hook", subtype: "Componente da pesca", 
                power: 1, rarity: "common", reqLevel: 1, weight: 1, value: 3,
                icon: "üìé"
            },
            "sharp_hook": { 
                name: "Amo Affilato", type: "hook", subtype: "Componente da pesca", 
                power: 3, rarity: "uncommon", reqLevel: 4, weight: 1, value: 15,
                icon: "üî™"
            },
            "barbed_hook": { 
                name: "Amo Dentato", type: "hook", subtype: "Componente da pesca", 
                power: 6, rarity: "rare", reqLevel: 7, weight: 2, value: 40,
                icon: "ü¶∑"
            },
            "golden_hook": { 
                name: "Amo Dorato", type: "hook", subtype: "Componente da pesca", 
                power: 10, rarity: "epic", reqLevel: 12, weight: 3, value: 120,
                icon: "üåü"
            },
            "divine_hook": { 
                name: "Amo Divino", type: "hook", subtype: "Componente da pesca", 
                power: 15, rarity: "legendary", reqLevel: 18, weight: 4, value: 300,
                icon: "üëº"
            },
            
            // Esche
            "worm": { 
                name: "Verme", type: "bait", subtype: "Consumabile", 
                power: 2, rarity: "common", reqLevel: 1, uses: 3, weight: 1, value: 5,
                icon: "ü™±"
            },
            "cricket": { 
                name: "Grillo", type: "bait", subtype: "Consumabile", 
                power: 4, rarity: "uncommon", reqLevel: 2, uses: 2, weight: 1, value: 12,
                icon: "ü¶ó"
            },
            "minnow": { 
                name: "Pesciolino", type: "bait", subtype: "Consumabile", 
                power: 6, rarity: "rare", reqLevel: 5, uses: 1, weight: 2, value: 25,
                icon: "üê†"
            },
            "magic_bait": { 
                name: "Esca Magica", type: "bait", subtype: "Consumabile", 
                power: 10, rarity: "epic", reqLevel: 12, uses: 1, weight: 1, value: 60,
                icon: "üîÆ"
            },
            "golden_lure": { 
                name: "Richiamo Dorato", type: "bait", subtype: "Consumabile", 
                power: 15, rarity: "legendary", reqLevel: 20, uses: 1, weight: 2, value: 150,
                icon: "üíé"
            },
            
            // Pesci
            "sardine": { 
                name: "Sardina", type: "fish", subtype: "Pesce", 
                value: 5, exp: 10, rarity: "common", weight: 2,
                icon: "üêü"
            },
            "bass": { 
                name: "Spigola", type: "fish", subtype: "Pesce", 
                value: 15, exp: 25, rarity: "uncommon", weight: 4,
                icon: "üê°"
            },
            "trout": { 
                name: "Trota", type: "fish", subtype: "Pesce", 
                value: 35, exp: 50, rarity: "rare", weight: 6,
                icon: "üê†"
            },
            "salmon": { 
                name: "Salmone", type: "fish", subtype: "Pesce", 
                value: 75, exp: 100, rarity: "epic", weight: 8,
                icon: "üêü"
            },
            "golden_fish": { 
                name: "Pesce Dorato", type: "fish", subtype: "Pesce", 
                value: 200, exp: 250, rarity: "legendary", weight: 10,
                icon: "üê†"
            },
            
            // Cibo cotto
            "cooked_sardine": { 
                name: "Sardina Cotta", type: "food", subtype: "Consumabile", 
                energyRestore: 5, rarity: "common", weight: 1, value: 8,
                icon: "üçΩÔ∏è"
            },
            "cooked_bass": { 
                name: "Spigola Cotta", type: "food", subtype: "Consumabile", 
                energyRestore: 10, rarity: "uncommon", weight: 2, value: 20,
                icon: "üçõ"
            },
            "cooked_trout": { 
                name: "Trota Cotta", type: "food", subtype: "Consumabile", 
                energyRestore: 20, rarity: "rare", weight: 3, value: 45,
                icon: "üçú"
            },
            "cooked_salmon": { 
                name: "Salmone Cotto", type: "food", subtype: "Consumabile", 
                energyRestore: 30, rarity: "epic", weight: 4, value: 90,
                icon: "üç≤"
            },
            "cooked_golden_fish": { 
                name: "Pesce Dorato Cotto", type: "food", subtype: "Consumabile", 
                energyRestore: 50, rarity: "legendary", weight: 5, value: 250,
                icon: "üç≥"
            },
            
            // Oggetti speciali
            "water_bottle": {
                name: "Borraccia d'Acqua", type: "drink", subtype: "Consumabile",
                energyRestore: 20, rarity: "uncommon", weight: 2, value: 20,
                icon: "üß¥", purchaseOnly: true, purchasePrice: 40
            }
        };
        
        // Lista achievements
        const achievementsList = [
            { id: 'first_fish', name: 'Primo Pesce', description: 'Pesca il tuo primo pesce', icon: 'üé£' },
            { id: 'first_rare', name: 'Cacciatore Raro', description: 'Pesca un pesce raro', icon: '‚ú®' },
            { id: 'first_epic', name: 'Maestro Epico', description: 'Pesca un pesce epico', icon: 'üî•' },
            { id: 'first_legendary', name: 'Leggenda Vivente', description: 'Pesca un pesce leggendario', icon: 'üèÜ' },
            { id: 'level_5', name: 'In Crescita', description: 'Raggiungi il livello 5', icon: 'üìà' },
            { id: 'level_10', name: 'Esperto', description: 'Raggiungi il livello 10', icon: 'üéØ' },
            { id: 'level_20', name: 'Maestro', description: 'Raggiungi il livello 20', icon: 'üëë' },
            { id: 'level_30', name: 'Leggenda', description: 'Raggiungi il livello massimo 30', icon: 'üåü' },
            { id: 'rich_100', name: 'Ricco', description: 'Accumula 100 monete', icon: 'üí∞' },
            { id: 'rich_500', name: 'Molto Ricco', description: 'Accumula 500 monete', icon: 'üíé' },
            { id: 'collector_10', name: 'Collezionista', description: 'Possiedi 10 carte diverse', icon: 'üé¥' },
            { id: 'collector_25', name: 'Archivista', description: 'Possiedi 25 carte diverse', icon: 'üìö' },
            { id: 'pack_master', name: 'Apriscatole', description: 'Apri 10 pacchetti di carte', icon: 'üì¶' },
            { id: 'fisherman_100', name: 'Pescatore Instancabile', description: 'Pesca 100 volte', icon: 'üåä' },
            { id: 'cook_first', name: 'Chef Novizio', description: 'Cucina il tuo primo pesce', icon: 'üë®‚Äçüç≥' },
            { id: 'full_inventory', name: 'Zaino Pieno', description: 'Riempi completamente l\'inventario', icon: 'üéí' },
            { id: 'weight_lifter', name: 'Sollevatore', description: 'Raggiungi 80 di capacit√† peso', icon: 'üí™' },
            { id: 'energetic', name: 'Energico', description: 'Mantieni energia al massimo per 1 ora', icon: '‚ö°' },
            { id: 'trader', name: 'Commerciante', description: 'Vendi oggetti per 200 monete totali', icon: 'ü§ù' },
            { id: 'explorer', name: 'Esploratore', description: 'Visita tutte le location', icon: 'üó∫Ô∏è' }
        ];
        
        // Probabilit√† delle carte per rarit√†
        const cardRarities = {
            common: 50,
            uncommon: 25,
            rare: 15,
            epic: 8,
            legendary: 2
        };
        
        let selectedCardSlot = null;
        
        function generateGameId() {
            return Math.random().toString(16).substr(2, 8);
        }
        
        function updateUI() {
            document.getElementById('player-level').textContent = gameState.player.level;
            document.getElementById('player-exp').textContent = `${gameState.player.exp}/${gameState.player.expToNext}`;
            document.getElementById('player-coins').textContent = gameState.player.coins;
            document.getElementById('player-energy').textContent = `${gameState.player.energy}/${gameState.player.maxEnergy}`;
            document.getElementById('player-weight').textContent = `${gameState.player.currentWeight}/${gameState.player.maxWeight}`;
            document.getElementById('player-strength').textContent = gameState.player.strength;
            document.getElementById('player-luck').textContent = gameState.player.luck;
            
            updateInventoryDisplay();
            updateEquipmentDisplay();
            
            // NON chiamare updateLocation() se si sta pescando!
            if (!gameState.isFishing) {
                updateLocation();
            }
        }
        
        function updateInventoryDisplay() {
            const grid = document.getElementById('inventory-grid');
            const title = document.getElementById('inventory-title');
            grid.innerHTML = '';
            
            const filledSlots = gameState.inventory.filter(item => item !== null).length;
            title.textContent = `üíº INVENTARIO (${filledSlots}/20)`;
            
            for (let i = 0; i < 20; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                
                if (gameState.inventory[i]) {
                    const item = gameState.inventory[i];
                    slot.className += ` occupied rarity-${item.rarity}`;
                    slot.innerHTML = `
                        <div style="font-size: 20px;">${item.icon}</div>
                        <div style="font-size: 6px; margin-top: 2px;">${item.name.split(' ')[0]}</div>
                    `;
                    slot.onclick = () => showCardStats(i);
                }
                
                grid.appendChild(slot);
            }
        }
        
        function updateEquipmentDisplay() {
            const eq = gameState.equipment;
            
            // Aggiorna slot canna
            const rodSlot = document.getElementById('rod-slot');
            if (eq.rod) {
                rodSlot.className = 'equipment-slot rod-slot equipped';
                rodSlot.innerHTML = `
                    <div>
                        <span style="font-size: 16px;">${eq.rod.icon}</span>
                        <div>Canna: ${eq.rod.name.replace('Canna ', '')}</div>
                    </div>
                `;
                rodSlot.onclick = () => showEquipmentStats(eq.rod);
                rodSlot.style.cursor = 'pointer';
            } else {
                rodSlot.className = 'equipment-slot rod-slot';
                rodSlot.innerHTML = '<div>Canna: Nessuna</div>';
                rodSlot.onclick = null;
                rodSlot.style.cursor = 'default';
            }
            
            // Aggiorna slot lenza
            const lineSlot = document.getElementById('line-slot');
            if (eq.line) {
                lineSlot.className = 'equipment-slot line-slot equipped';
                lineSlot.innerHTML = `
                    <div>
                        <span style="font-size: 16px;">${eq.line.icon}</span>
                        <div>Lenza: ${eq.line.name.replace('Lenza ', '')}</div>
                    </div>
                `;
                lineSlot.onclick = () => showEquipmentStats(eq.line);
                lineSlot.style.cursor = 'pointer';
            } else {
                lineSlot.className = 'equipment-slot line-slot';
                lineSlot.innerHTML = '<div>Lenza: Nessuna</div>';
                lineSlot.onclick = null;
                lineSlot.style.cursor = 'default';
            }
            
            // Aggiorna slot amo
            const hookSlot = document.getElementById('hook-slot');
            if (eq.hook) {
                hookSlot.className = 'equipment-slot hook-slot equipped';
                hookSlot.innerHTML = `
                    <div>
                        <span style="font-size: 16px;">${eq.hook.icon}</span>
                        <div>Amo: ${eq.hook.name.replace('Amo ', '')}</div>
                    </div>
                `;
                hookSlot.onclick = () => showEquipmentStats(eq.hook);
                hookSlot.style.cursor = 'pointer';
            } else {
                hookSlot.className = 'equipment-slot hook-slot';
                hookSlot.innerHTML = '<div>Amo: Nessuno</div>';
                hookSlot.onclick = null;
                hookSlot.style.cursor = 'default';
            }
            
            // Aggiorna slot esca
            const baitSlot = document.getElementById('bait-slot');
            if (eq.bait) {
                baitSlot.className = 'equipment-slot bait-slot equipped';
                baitSlot.innerHTML = `
                    <div>
                        <span style="font-size: 16px;">${eq.bait.icon}</span>
                        <div>Esca: ${eq.bait.name} ${eq.bait.uses ? `(${eq.bait.uses})` : ''}</div>
                    </div>
                `;
                baitSlot.onclick = () => showEquipmentStats(eq.bait);
                baitSlot.style.cursor = 'pointer';
            } else {
                baitSlot.className = 'equipment-slot bait-slot';
                baitSlot.innerHTML = '<div>Esca: Nessuna</div>';
                baitSlot.onclick = null;
                baitSlot.style.cursor = 'default';
            }
        }
        
        function calculateCurrentWeight() {
            let weight = 0;
            gameState.inventory.forEach(item => {
                if (item) weight += item.weight || 0;
            });
            
            // Aggiungi peso equipaggiamento
            Object.values(gameState.equipment).forEach(item => {
                if (item) weight += item.weight || 0;
            });
            
            gameState.player.currentWeight = weight;
            gameState.player.maxWeight = 50 + (gameState.player.strength * 5);
        }
        
        function addToInventory(item) {
            calculateCurrentWeight();
            
            if (gameState.player.currentWeight + (item.weight || 0) > gameState.player.maxWeight) {
                showResult("Troppo pesante! Non puoi trasportare questo oggetto.", 'error');
                return false;
            }
            
            for (let i = 0; i < 20; i++) {
                if (!gameState.inventory[i]) {
                    gameState.inventory[i] = {...item, id: Math.random().toString(16).substr(2, 8)};
                    calculateCurrentWeight();
                    return true;
                }
            }
            return false; // Inventario pieno
        }
        
        function showCardStats(slotIndex) {
            const item = gameState.inventory[slotIndex];
            if (!item) return;
            
            selectedCardSlot = slotIndex;
            
            const modal = document.getElementById('card-stats-modal');
            const title = document.getElementById('card-stats-title');
            const content = document.getElementById('card-stats-content');
            const sellBtn = document.getElementById('sell-card-btn');
            
            title.textContent = `üìä ${item.name}`;
            
            // Bottone "USA" per consumabili
            const isConsumable = item.type === 'food' || item.type === 'drink';
            const useButtonHTML = isConsumable ? 
                `<button class="btn" onclick="useSelectedItem()" style="margin-right: 10px;">
                    ${item.type === 'drink' ? 'üß¥ BEVI' : 'üçΩÔ∏è MANGIA'}
                </button>` : '';
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 60px; margin-bottom: 10px;">${item.icon}</div>
                </div>
                <div style="background: #34495e; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Tipo:</strong> ${item.subtype}</p>
                    <p><strong>Peso:</strong> ${item.weight || 0} kg</p>
                    <p><strong>Rarit√†:</strong> ${item.rarity.charAt(0).toUpperCase() + item.rarity.slice(1)}</p>
                    <p><strong>Valore:</strong> ${item.value || 0} monete</p>
                    ${item.power ? `<p><strong>Potenza:</strong> ${item.power}</p>` : ''}
                    ${item.reqLevel ? `<p><strong>Livello richiesto:</strong> ${item.reqLevel}</p>` : ''}
                    ${item.uses ? `<p><strong>Usi rimanenti:</strong> ${item.uses}</p>` : ''}
                    ${item.energyRestore ? `<p><strong>Energia ripristinata:</strong> +${item.energyRestore}</p>` : ''}
                    ${item.exp ? `<p><strong>Esperienza:</strong> ${item.exp}</p>` : ''}
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    ${useButtonHTML}
                </div>
            `;
            
            // Configura pulsante vendita
            if (item.subtype === 'Pesce') {
                if (gameState.currentLocation === 'port') {
                    sellBtn.textContent = 'üêü VENDI PESCE';
                    sellBtn.style.display = 'inline-block';
                    sellBtn.disabled = false;
                } else {
                    sellBtn.textContent = '‚öì PORTA AL PORTO';
                    sellBtn.style.display = 'inline-block';
                    sellBtn.disabled = true;
                }
            } else {
                sellBtn.textContent = 'üí∞ VENDI';
                sellBtn.style.display = 'inline-block';
                sellBtn.disabled = false;
            }
            
            modal.style.display = 'flex';
        }
        
        function showEquipmentStats(equipment) {
            if (!equipment) return;
            
            const modal = document.getElementById('card-stats-modal');
            const title = document.getElementById('card-stats-title');
            const content = document.getElementById('card-stats-content');
            const sellBtn = document.getElementById('sell-card-btn');
            
            title.textContent = `‚öôÔ∏è ${equipment.name}`;
            
            // Effetti reali dell'equipaggiamento
            let effectsHTML = '';
            if (equipment.power) {
                effectsHTML = `
                    <div style="background: #2c3e50; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong>üéØ Effetti sulla Pesca:</strong></p>
                        <p>‚Ä¢ Aumenta la probabilit√† di successo del +${equipment.power}%</p>
                        <p>‚Ä¢ Contribuisce al bonus equipaggiamento totale</p>
                        ${equipment.type === 'bait' && equipment.uses ? `<p>‚Ä¢ Usi rimanenti: ${equipment.uses}</p>` : ''}
                    </div>
                `;
            }
            
            // Calcolo bonus totale attuale
            const totalPower = getEquipmentPower();
            const bonusInfo = `
                <div style="background: #34495e; padding: 10px; border-radius: 8px; margin: 10px 0; border: 2px solid #f39c12;">
                    <p style="text-align: center; font-size: 10px; color: #f39c12;">
                        üìä Bonus Equipaggiamento Totale: +${totalPower}% probabilit√† successo
                    </p>
                </div>
            `;
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <div style="font-size: 60px; margin-bottom: 10px;">${equipment.icon}</div>
                </div>
                <div style="background: #34495e; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Tipo:</strong> ${equipment.subtype || 'Equipaggiamento'}</p>
                    <p><strong>Potenza:</strong> ${equipment.power || 0}</p>
                    <p><strong>Peso:</strong> ${equipment.weight || 0} kg</p>
                    <p><strong>Rarit√†:</strong> ${equipment.rarity ? equipment.rarity.charAt(0).toUpperCase() + equipment.rarity.slice(1) : 'Comune'}</p>
                    <p><strong>Valore:</strong> ${equipment.value || 0} monete</p>
                    ${equipment.reqLevel ? `<p><strong>Livello richiesto:</strong> ${equipment.reqLevel}</p>` : ''}
                </div>
                ${effectsHTML}
                ${bonusInfo}
                <div style="background: #27ae60; padding: 10px; border-radius: 8px; margin: 10px 0;">
                    <p style="text-align: center; font-size: 9px; color: #fff;">
                        ‚ú® Equipaggiato e attivo
                    </p>
                </div>
            `;
            
            // Nascondi pulsante vendita per equipaggiamento attivo
            sellBtn.style.display = 'none';
            
            modal.style.display = 'flex';
        }
        
        function useSelectedItem() {
            if (selectedCardSlot !== null) {
                useItem(selectedCardSlot);
                closeModal('card-stats-modal');
                selectedCardSlot = null;
            }
        }
        
        function sellSelectedCard() {
            if (selectedCardSlot === null) return;
            
            const item = gameState.inventory[selectedCardSlot];
            if (!item) return;
            
            // Controlla se √® un pesce e se siamo al porto
            if (item.subtype === 'Pesce' && gameState.currentLocation !== 'port') {
                showResult("I pesci si possono vendere solo al porto!", 'error');
                return;
            }
            
            // Vendi l'oggetto
            gameState.player.coins += item.value || 0;
            gameState.inventory[selectedCardSlot] = null;
            
            vibrate(50); // Feedback vendita
            
            calculateCurrentWeight();
            updateUI();
            closeModal('card-stats-modal');
            
            showResult(`Hai venduto ${item.name} per ${item.value} monete!`, 'success');
            
            checkAchievement('trader');
            selectedCardSlot = null;
        }
        
        function useItem(slotIndex) {
            const item = gameState.inventory[slotIndex];
            if (!item) return;
            
            if (item.reqLevel && item.reqLevel > gameState.player.level) {
                showResult(`Livello ${item.reqLevel} richiesto per ${item.name}!`, 'error');
                return;
            }
            
            if (item.type === 'food' || item.type === 'drink') {
                // Consuma il cibo/bevanda
                const energyBefore = gameState.player.energy;
                gameState.player.energy = Math.min(gameState.player.maxEnergy, gameState.player.energy + item.energyRestore);
                const energyRestored = gameState.player.energy - energyBefore;
                
                gameState.inventory[slotIndex] = null;
                vibrate(40); // Feedback consumo
                
                if (item.type === 'drink') {
                    showResult(`üß¥ Hai bevuto ${item.name}! +${energyRestored} energia`, 'success');
                } else {
                    showResult(`üçΩÔ∏è Hai mangiato ${item.name}! +${energyRestored} energia`, 'success');
                }
            } else if (['rod', 'line', 'hook', 'bait'].includes(item.type)) {
                // Equipaggia l'oggetto
                const oldItem = gameState.equipment[item.type];
                gameState.equipment[item.type] = item;
                gameState.inventory[slotIndex] = oldItem;
                vibrate(30); // Feedback equipaggiamento
                showResult(`‚öôÔ∏è Hai equipaggiato ${item.name}!`, 'success');
            }
            
            calculateCurrentWeight();
            updateUI();
        }
        
        function updateLocation() {
            const area = document.getElementById('location-area');
            const content = document.getElementById('location-content');
            
            if (!content) {
                return;
            }
            
            // Rimuovi tutte le classi bg
            area.className = 'location-area';
            
            switch(gameState.currentLocation) {
                case 'fishing':
                    area.classList.add('fishing-bg');
                    content.innerHTML = getFishingLocationHTML();
                    break;
                case 'home':
                    area.classList.add('home-bg');
                    content.innerHTML = getHomeLocationHTML();
                    break;
                case 'port':
                    area.classList.add('port-bg');
                    content.innerHTML = getPortLocationHTML();
                    break;
                case 'kitchen':
                    area.classList.add('kitchen-bg');
                    content.innerHTML = getKitchenLocationHTML();
                    break;
            }
        }
        
        function getFishingLocationHTML() {
            return `
                <div class="navigation">
                    <button class="nav-btn ${gameState.currentLocation === 'fishing' ? 'active' : ''}" onclick="changeLocation('fishing')">üåä PESCA</button>
                    <button class="nav-btn ${gameState.currentLocation === 'home' ? 'active' : ''}" onclick="changeLocation('home')">üè† CASA</button>
                    <button class="nav-btn ${gameState.currentLocation === 'port' ? 'active' : ''}" onclick="changeLocation('port')">‚öì PORTO</button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <h3>üåä Lago della Citt√† Vecchia üåä</h3>
                    <p>Un tranquillo specchio d'acqua ricco di misteri...</p>
                    <div style="margin: 20px 0;">
                        <button class="btn" id="fish-btn" onclick="startFishing()" ${gameState.isFishing ? 'disabled' : ''}>üé£ PESCA</button>
                    </div>
                    <div id="fishing-progress" style="display: none;">
                        <div id="fishing-phase-text" style="margin-bottom: 10px; font-size: 12px; color: #f39c12;">Lanciando la lenza...</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="fishing-bar"></div>
                        </div>
                        <div id="fishing-status" style="margin-top: 10px; font-size: 10px; color: #ecf0f1;">
                            <span id="fishing-timer">0.0s</span> | 
                            <span id="fishing-chance">Possibilit√†: --</span>
                        </div>
                    </div>
                </div>
                
                <div id="fishing-results"></div>
                <div id="achievements"></div>
            `;
        }
        
        function getHomeLocationHTML() {
            return `
                <div class="navigation">
                    <button class="nav-btn ${gameState.currentLocation === 'fishing' ? 'active' : ''}" onclick="changeLocation('fishing')">üåä PESCA</button>
                    <button class="nav-btn ${gameState.currentLocation === 'home' ? 'active' : ''}" onclick="changeLocation('home')">üè† CASA</button>
                    <button class="nav-btn ${gameState.currentLocation === 'port' ? 'active' : ''}" onclick="changeLocation('port')">‚öì PORTO</button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <h3>üè† La Tua Casa üè†</h3>
                    <p>Un rifugio sicuro dove riposare e crescere...</p>
                    
                    <div class="home-buttons">
                        <button class="btn btn-large" onclick="levelUp()" ${gameState.player.canLevelUp ? '' : 'disabled'}>
                            üìà LIVELLO UP<br>
                            <small>${gameState.player.canLevelUp ? 'Disponibile!' : 'Serve pi√π EXP'}</small>
                        </button>
                        
                        <button class="btn btn-large btn-secondary" onclick="showAchievements()">
                            üèÜ ACHIEVEMENTS<br>
                            <small>${gameState.achievements.length}/${achievementsList.length}</small>
                        </button>
                        
                        <button class="btn btn-large" onclick="rest()">
                            üò¥ RIPOSARE<br>
                            <small>Ripristina energia</small>
                        </button>
                        
                        <button class="btn btn-large btn-secondary" onclick="changeLocation('kitchen')">
                            üç≥ CUCINA<br>
                            <small>Prepara il cibo</small>
                        </button>
                    </div>
                </div>
                
                <div id="fishing-results"></div>
                <div id="achievements"></div>
            `;
        }
        
        function getPortLocationHTML() {
            return `
                <div class="navigation">
                    <button class="nav-btn ${gameState.currentLocation === 'fishing' ? 'active' : ''}" onclick="changeLocation('fishing')">üåä PESCA</button>
                    <button class="nav-btn ${gameState.currentLocation === 'home' ? 'active' : ''}" onclick="changeLocation('home')">üè† CASA</button>
                    <button class="nav-btn ${gameState.currentLocation === 'port' ? 'active' : ''}" onclick="changeLocation('port')">‚öì PORTO</button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <h3>‚öì Porto della Citt√† ‚öì</h3>
                    <p>Il centro commerciale dei pescatori...</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-large" onclick="sellAllFish()">
                            üêü VENDI TUTTO IL PESCE<br>
                            <small>Vendi tutto in una volta</small>
                        </button>
                        
                        <button class="btn btn-large btn-secondary" onclick="buyWaterBottle()">
                            üß¥ COMPRA BORRACCIA<br>
                            <small>40 monete - Ripristina 20 energia</small>
                        </button>
                        
                        <button class="btn btn-large" onclick="openTradeCenter()" disabled>
                            ü§ù SCAMBI CARTE<br>
                            <small>Prossimamente...</small>
                        </button>
                    </div>
                </div>
                
                <div id="fishing-results"></div>
                <div id="achievements"></div>
            `;
        }
        
        function getKitchenLocationHTML() {
            return `
                <div style="text-align: center;">
                    <button class="btn" onclick="changeLocation('home')">‚¨ÖÔ∏è TORNA A CASA</button>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <h3>üç≥ Cucina di Casa üç≥</h3>
                    <p>Prepara deliziosi piatti dai tuoi pesci...</p>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-large" onclick="showCookingMenu()">
                            üë®‚Äçüç≥ CUCINA PESCE<br>
                            <small>Trasforma pesce in cibo</small>
                        </button>
                        
                        <button class="btn btn-large btn-secondary" onclick="showFoodMenu()">
                            üçΩÔ∏è MANGIA CIBO<br>
                            <small>Ripristina energia</small>
                        </button>
                        
                        <button class="btn btn-large" onclick="showFreezeMenu()">
                            üßä CONGELA PESCE<br>
                            <small>Conserva per dopo</small>
                        </button>
                    </div>
                </div>
                
                <div id="fishing-results"></div>
                <div id="achievements"></div>
            `;
        }
        
        function changeLocation(newLocation) {
            if (gameState.isFishing && newLocation !== 'fishing') {
                showResult("Non puoi andare via mentre stai pescando!", 'error');
                return;
            }
            
            if (newLocation !== gameState.currentLocation) {
                if (gameState.player.energy < 10) {
                    showResult("Non hai abbastanza energia per spostarti!", 'error');
                    return;
                }
                
                if (gameState.currentLocation !== 'home' || newLocation !== 'kitchen') {
                    gameState.player.energy -= 10;
                }
            }
            
            gameState.currentLocation = newLocation;
            updateUI();
            
            checkAchievement('explorer');
        }
        
        function startFishing() {
            if (gameState.player.energy < 1) {
                showResult("Non hai abbastanza energia per pescare!", 'error');
                return;
            }
            
            const fishBtn = document.getElementById('fish-btn');
            const progressDiv = document.getElementById('fishing-progress');
            const progressBar = document.getElementById('fishing-bar');
            const phaseText = document.getElementById('fishing-phase-text');
            const timer = document.getElementById('fishing-timer');
            const chanceDisplay = document.getElementById('fishing-chance');
            
            if (!progressDiv) {
                updateLocation();
                
                setTimeout(() => {
                    const retryProgressDiv = document.getElementById('fishing-progress');
                    if (!retryProgressDiv) {
                        showResult("‚ùå Errore: barra progresso non trovata. Prova a ricaricare la pagina.", 'error');
                        return;
                    }
                    continueStartFishing(retryProgressDiv);
                }, 100);
                return;
            }
            
            continueStartFishing(progressDiv);
        }
        
        function continueStartFishing(progressDiv) {
            const fishBtn = document.getElementById('fish-btn');
            const progressBar = document.getElementById('fishing-bar');
            const phaseText = document.getElementById('fishing-phase-text');
            const timer = document.getElementById('fishing-timer');
            const chanceDisplay = document.getElementById('fishing-chance');
            
            gameState.isFishing = true;
            gameState.player.energy -= 1;
            
            vibrate(30);
            
            if (fishBtn) fishBtn.disabled = true;
            if (progressDiv) progressDiv.style.display = 'block';
            
            let progress = 0;
            const fishingTime = 4000;
            const startTime = Date.now();
            let currentPhase = 0;
            
            const phases = [
                { percent: 25, text: "üé£ Lanciando la lenza...", color: "#3498db" },
                { percent: 50, text: "‚è≥ Aspettando che abbocchi...", color: "#f39c12" },
                { percent: 75, text: "üêü Qualcosa sta mordendo!", color: "#e67e22" },
                { percent: 100, text: "üí™ Tirando fuori la preda!", color: "#e74c3c" }
            ];
            
            const interval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                progress = Math.min(100, (elapsed / fishingTime) * 100);
                
                if (progressBar) progressBar.style.width = progress + '%';
                if (timer) timer.textContent = (elapsed / 1000).toFixed(1) + 's';
                
                const baseChance = 60;
                const equipmentBonus = getEquipmentPower();
                const luckBonus = gameState.player.luck * 2;
                const timeBonus = Math.floor(progress / 10) * 2;
                const currentChance = Math.min(95, baseChance + equipmentBonus + luckBonus + timeBonus);
                if (chanceDisplay) chanceDisplay.textContent = `Possibilit√†: ${currentChance}%`;
                
                const newPhase = phases.findIndex(phase => progress < phase.percent);
                const phaseIndex = newPhase === -1 ? phases.length - 1 : Math.max(0, newPhase - 1);
                
                if (phaseIndex !== currentPhase) {
                    currentPhase = phaseIndex;
                    if (phaseText) phaseText.textContent = phases[currentPhase].text;
                    if (progressBar) progressBar.style.background = `linear-gradient(90deg, ${phases[currentPhase].color}, #f39c12)`;
                    
                    if (phaseIndex === 2) vibrate(60);
                    if (phaseIndex === 3) vibrate([40, 20, 40]);
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    if (progressDiv) progressDiv.style.display = 'none';
                    if (fishBtn) fishBtn.disabled = false;
                    if (progressBar) {
                        progressBar.style.width = '0%';
                        progressBar.style.background = 'linear-gradient(90deg, #e74c3c, #f39c12)';
                    }
                    gameState.isFishing = false;
                    resolveFishing();
                }
            }, 50);
            
            updateUI();
        }
        
        function resolveFishing() {
            const baseChance = 60;
            const equipmentBonus = getEquipmentPower();
            const luckBonus = gameState.player.luck * 2;
            const timeBonus = 8; // Bonus completo per aver finito la sequenza
            const successChance = Math.min(95, baseChance + equipmentBonus + luckBonus + timeBonus);
            
            if (Math.random() * 100 > successChance) {
                showResult("üåä La preda √® scappata all'ultimo momento! Riprova.", 'fail');
                vibrate(100); // Vibrazione di fallimento
                return;
            }
            
            const lootTable = [
                { items: ['sardine'], weight: 40 },
                { items: ['bass'], weight: 25 },
                { items: ['trout'], weight: 15 },
                { items: ['salmon'], weight: 10 },
                { items: ['golden_fish'], weight: 5 },
                { items: ['worm', 'cricket'], weight: 5 }
            ];
            
            const rolled = Math.random() * 100;
            let cumulative = 0;
            let caughtItem = null;
            
            for (const entry of lootTable) {
                cumulative += entry.weight;
                if (rolled <= cumulative) {
                    const randomItem = entry.items[Math.floor(Math.random() * entry.items.length)];
                    caughtItem = itemDatabase[randomItem];
                    break;
                }
            }
            
            if (caughtItem) {
                if (addToInventory(caughtItem)) {
                    // Vibrazione basata sulla rarit√†
                    if (caughtItem.rarity === 'legendary') {
                        vibrate([100, 50, 100, 50, 100]);
                    } else if (caughtItem.rarity === 'epic') {
                        vibrate([80, 30, 80]);
                    } else if (caughtItem.rarity === 'rare') {
                        vibrate(60);
                    } else {
                        vibrate(40);
                    }
                    
                    if (caughtItem.type === 'fish') {
                        gameState.player.exp += caughtItem.exp;
                        showResult(`üé£ Perfetto! Hai pescato ${caughtItem.icon} ${caughtItem.name}! (+${caughtItem.exp} EXP)`, 'success');
                        checkFishingAchievements(caughtItem);
                    } else {
                        showResult(`üîß Incredibile! Hai trovato ${caughtItem.icon} ${caughtItem.name}!`, 'success');
                    }
                    
                    if (gameState.equipment.bait) {
                        gameState.equipment.bait.uses--;
                        if (gameState.equipment.bait.uses <= 0) {
                            gameState.equipment.bait = null;
                            showResult("üé£ La tua esca √® finita!", 'info');
                        }
                    }
                    
                    checkLevelUp();
                    updateUI();
                } else {
                    showResult("‚ö†Ô∏è Inventario pieno o troppo pesante! Non puoi raccogliere pi√π oggetti.", 'error');
                }
            }
        }
        
        function getEquipmentPower() {
            let power = 0;
            if (gameState.equipment.rod) power += gameState.equipment.rod.power;
            if (gameState.equipment.line) power += gameState.equipment.line.power;
            if (gameState.equipment.hook) power += gameState.equipment.hook.power;
            if (gameState.equipment.bait) power += gameState.equipment.bait.power;
            return power;
        }
        
        function checkLevelUp() {
            if (gameState.player.exp >= gameState.player.expToNext) {
                gameState.player.canLevelUp = true;
                showResult("üè† Torna a casa per salire di livello!", 'level');
            }
        }
        
        function levelUp() {
            if (!gameState.player.canLevelUp) return;
            
            vibrate([200, 100, 200]);
            
            gameState.player.level++;
            gameState.player.exp -= gameState.player.expToNext;
            gameState.player.expToNext = gameState.player.level * 100;
            gameState.player.strength += 2;
            gameState.player.luck += 1;
            gameState.player.canLevelUp = false;
            
            showResult(`üéâ LIVELLO ${gameState.player.level}! +2 Forza, +1 Fortuna`, 'level');
            
            checkLevelAchievements();
            calculateCurrentWeight();
            updateUI();
        }
        
        function rest() {
            gameState.player.energy = gameState.player.maxEnergy;
            showResult("üò¥ Ti sei riposato! Energia ripristinata al massimo.", 'success');
            updateUI();
        }
        
        function sellAllFish() {
            let totalValue = 0;
            let soldCount = 0;
            
            for (let i = 0; i < gameState.inventory.length; i++) {
                const item = gameState.inventory[i];
                if (item && item.subtype === 'Pesce') {
                    totalValue += item.value;
                    soldCount++;
                    gameState.inventory[i] = null;
                }
            }
            
            if (soldCount > 0) {
                gameState.player.coins += totalValue;
                vibrate(80); // Feedback vendita multipla
                showResult(`Hai venduto ${soldCount} pesci per ${totalValue} monete!`, 'success');
                checkAchievement('trader');
            } else {
                showResult("Non hai pesci da vendere!", 'error');
            }
            
            calculateCurrentWeight();
            updateUI();
        }
        
        function buyWaterBottle() {
            const waterBottle = itemDatabase.water_bottle;
            const cost = waterBottle.purchasePrice || waterBottle.value;
            
            if (gameState.player.coins < cost) {
                showResult(`Non hai abbastanza monete! Servono ${cost} monete.`, 'error');
                return;
            }
            
            // Controllo spazio e peso
            if (!addToInventory(waterBottle)) {
                showResult("Inventario pieno o troppo pesante!", 'error');
                return;
            }
            
            gameState.player.coins -= cost;
            vibrate(60); // Feedback acquisto
            
            showResult(`üß¥ Hai comprato una ${waterBottle.name} per ${cost} monete!`, 'success');
            updateUI();
        }
        
        function showCookingMenu() {
            // Mostra modal con lista pesci da cucinare
            showResult("Funzione di cucina in sviluppo!", 'info');
        }
        
        function showFoodMenu() {
            // Mostra modal con lista cibo da mangiare
            showResult("Menu cibo in sviluppo!", 'info');
        }
        
        function showFreezeMenu() {
            // Mostra modal con opzioni congelamento
            showResult("Funzione congelamento in sviluppo!", 'info');
        }
        
        function openShop() {
            document.getElementById('shop-modal').style.display = 'flex';
        }
        
        function buyCardPack() {
            if (gameState.player.coins < 20) {
                showResult("Non hai abbastanza monete!", 'error');
                return;
            }
            
            vibrate(80);
            
            gameState.player.coins -= 20;
            const cards = generateCardPack();
            displayCardPack(cards);
            updateUI();
        }
        
        function generateCardPack() {
            const pack = [];
            
            for (let i = 0; i < 5; i++) {
                const rarity = rollRarity();
                const itemsOfRarity = Object.entries(itemDatabase)
                    .filter(([key, item]) => item.rarity === rarity && item.type !== 'fish');
                
                if (itemsOfRarity.length > 0) {
                    const randomItem = itemsOfRarity[Math.floor(Math.random() * itemsOfRarity.length)][1];
                    pack.push(randomItem);
                }
            }
            
            return pack;
        }
        
        function rollRarity() {
            const roll = Math.random() * 100;
            let cumulative = 0;
            
            for (const [rarity, chance] of Object.entries(cardRarities)) {
                cumulative += chance;
                if (roll <= cumulative) {
                    return rarity;
                }
            }
            return 'common';
        }
        
        function displayCardPack(cards) {
            closeModal('shop-modal');
            
            const modal = document.getElementById('pack-modal');
            const contents = document.getElementById('pack-contents');
            contents.innerHTML = '';
            
            cards.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `card rarity-${card.rarity}`;
                cardDiv.innerHTML = `
                    <div style="font-size: 40px; margin-bottom: 10px;">${card.icon}</div>
                    <h4>${card.name}</h4>
                    <p>Tipo: ${card.subtype}</p>
                    <p>Potenza: ${card.power || 'N/A'}</p>
                    <p>Rarit√†: ${card.rarity}</p>
                    <div style="margin-top: 10px; font-size: 8px; color: #ecf0f1;">
                        Clicca per aggiungere
                    </div>
                `;
                cardDiv.onclick = () => {
                    if (addToInventory(card)) {
                        cardDiv.style.opacity = '0.5';
                        cardDiv.onclick = null;
                        vibrate(30);
                        showResult(`${card.name} aggiunto all'inventario!`, 'success');
                        updateUI();
                    } else {
                        showResult("Inventario pieno o troppo pesante!", 'error');
                    }
                };
                contents.appendChild(cardDiv);
            });
            
            modal.style.display = 'flex';
        }
        
        function showAchievements() {
            const modal = document.getElementById('achievements-modal');
            const list = document.getElementById('achievements-list');
            list.innerHTML = '';
            
            achievementsList.forEach(achievement => {
                const div = document.createElement('div');
                div.className = `achievement-item ${gameState.achievements.includes(achievement.id) ? '' : 'locked'}`;
                div.innerHTML = `
                    <strong>${achievement.icon} ${achievement.name}</strong><br>
                    <small>${achievement.description}</small>
                    ${gameState.achievements.includes(achievement.id) ? '<span style="color: #2ecc71;"> ‚úì COMPLETATO</span>' : ''}
                `;
                list.appendChild(div);
            });
            
            modal.style.display = 'flex';
        }
        
        function checkFishingAchievements(fish) {
            checkAchievement('first_fish');
            
            if (fish.rarity === 'rare') checkAchievement('first_rare');
            if (fish.rarity === 'epic') checkAchievement('first_epic');
            if (fish.rarity === 'legendary') checkAchievement('first_legendary');
        }
        
        function checkLevelAchievements() {
            if (gameState.player.level >= 5) checkAchievement('level_5');
            if (gameState.player.level >= 10) checkAchievement('level_10');
            if (gameState.player.level >= 20) checkAchievement('level_20');
            if (gameState.player.level >= 30) checkAchievement('level_30');
        }
        
        function checkAchievement(achievementId) {
            if (!gameState.achievements.includes(achievementId)) {
                const achievement = achievementsList.find(a => a.id === achievementId);
                if (achievement) {
                    gameState.achievements.push(achievementId);
                    showAchievementNotification(achievement);
                }
            }
        }
        
        function showAchievementNotification(achievement) {
            const achievementsDiv = document.getElementById('achievements');
            const achievementDiv = document.createElement('div');
            achievementDiv.className = 'achievement';
            achievementDiv.innerHTML = `<strong>${achievement.icon} ${achievement.name}!</strong><br>${achievement.description}`;
            
            achievementsDiv.appendChild(achievementDiv);
            
            setTimeout(() => {
                if (achievementDiv.parentNode) {
                    achievementDiv.parentNode.removeChild(achievementDiv);
                }
            }, 5000);
        }
        
        function showResult(message, type) {
            const resultsDiv = document.getElementById('fishing-results');
            
            // Se non trova il container, lo crea dinamicamente
            if (!resultsDiv) {
                console.warn("Container risultati non trovato, creazione dinamica...");
                const locationContent = document.getElementById('location-content');
                if (locationContent) {
                    const newResultsDiv = document.createElement('div');
                    newResultsDiv.id = 'fishing-results';
                    locationContent.appendChild(newResultsDiv);
                } else {
                    // Fallback: mostra un alert
                    alert(message);
                    return;
                }
            }
            
            const finalResultsDiv = document.getElementById('fishing-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'fishing-result';
            resultDiv.textContent = message;
            
            const colors = {
                success: '#2ecc71',
                error: '#e74c3c',
                fail: '#f39c12',
                info: '#3498db',
                level: '#9b59b6'
            };
            
            resultDiv.style.borderColor = colors[type] || colors.info;
            resultDiv.style.backgroundColor = `${colors[type] || colors.info}20`;
            
            finalResultsDiv.appendChild(resultDiv);
            
            while (finalResultsDiv.children.length > 3) {
                finalResultsDiv.removeChild(finalResultsDiv.firstChild);
            }
            
            setTimeout(() => {
                if (resultDiv.parentNode) {
                    resultDiv.parentNode.removeChild(resultDiv);
                }
            }, 5000);
        }
        
        function toggleOptions() {
            document.getElementById('options-modal').style.display = 'flex';
        }
        
        function confirmNewGame() {
            // Aggiorna i valori nel modal con i progressi attuali
            const modal = document.getElementById('new-game-modal');
            modal.innerHTML = modal.innerHTML.replace(/Livello \d+/, `Livello ${gameState.player.level}`);
            modal.innerHTML = modal.innerHTML.replace(/\d+ EXP/, `${gameState.player.exp} EXP`);
            modal.innerHTML = modal.innerHTML.replace(/\d+ monete/, `${gameState.player.coins} monete`);
            modal.innerHTML = modal.innerHTML.replace(/\d+ achievement/, `${gameState.achievements.length} achievement`);
            
            closeModal('options-modal');
            document.getElementById('new-game-modal').style.display = 'flex';
        }
        
        function startNewGame() {
            // Reset completo del gameState
            gameState = {
                player: {
                    level: 1,
                    exp: 0,
                    expToNext: 100,
                    coins: 50,
                    energy: 100,
                    maxEnergy: 100,
                    strength: 5,
                    luck: 5,
                    maxWeight: 50,
                    currentWeight: 0,
                    canLevelUp: false
                },
                inventory: [],
                equipment: {
                    rod: { name: "Canna Semplice", type: "rod", power: 1, rarity: "common", weight: 5, value: 10, icon: "üé£" },
                    line: { name: "Lenza Base", type: "line", power: 1, rarity: "common", weight: 1, value: 5, icon: "üßµ" },
                    hook: { name: "Amo Piccolo", type: "hook", power: 1, rarity: "common", weight: 1, value: 3, icon: "üìé" },
                    bait: null
                },
                currentLocation: 'fishing',
                gameId: generateGameId(),
                achievements: [],
                isFishing: false,
                fontSizeLevel: gameState.fontSizeLevel || 0 // Mantieni solo il font size
            };
            
            // Riapplica font size se era personalizzato
            if (gameState.fontSizeLevel !== 0) {
                changeFontSize(0);
            }
            
            calculateCurrentWeight();
            updateUI();
            closeModal('new-game-modal');
            
            vibrate(80); // Feedback reset
            
            setTimeout(() => {
                showResult("üéÆ Nuova partita iniziata! Buona fortuna pescatore!", 'success');
            }, 300);
        }
        
        function changeFontSize(delta) {
            gameState.fontSizeLevel = Math.max(-2, Math.min(2, gameState.fontSizeLevel + delta));
            
            const sizes = ['Molto Piccolo', 'Piccolo', 'Normale', 'Grande', 'Molto Grande'];
            const baseSize = 10;
            const newSize = baseSize + (gameState.fontSizeLevel * 2);
            
            document.documentElement.style.setProperty('--font-size-base', newSize + 'px');
            document.documentElement.style.setProperty('--font-size-title', (24 + gameState.fontSizeLevel * 4) + 'px');
            document.documentElement.style.setProperty('--font-size-header', (16 + gameState.fontSizeLevel * 2) + 'px');
            document.documentElement.style.setProperty('--font-size-small', (8 + gameState.fontSizeLevel * 2) + 'px');
            
            document.getElementById('font-size-display').textContent = sizes[gameState.fontSizeLevel + 2];
        }
        
        function generateSaveCode() {
            console.log("üîç Generando codice di salvataggio...");
            
            const saveData = {
                player: gameState.player,
                inventory: gameState.inventory,
                equipment: gameState.equipment,
                achievements: gameState.achievements,
                currentLocation: gameState.currentLocation,
                gameId: gameState.gameId,
                fontSizeLevel: gameState.fontSizeLevel,
                timestamp: Date.now()
            };
            
            try {
                // Step 1: JSON stringify
                const jsonString = JSON.stringify(saveData);
                console.log("‚úÖ JSON generato, length:", jsonString.length);
                
                // Step 2: URI encode (per emoji)
                const encodedString = encodeURIComponent(jsonString);
                console.log("‚úÖ URI encoded, length:", encodedString.length);
                
                // Step 3: Base64 encode
                const base64String = btoa(encodedString);
                console.log("‚úÖ Base64 generato, length:", base64String.length);
                
                // Step 4: Hex encode
                const hexCode = base64String.split('').map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');
                console.log("‚úÖ Hex code generato, length:", hexCode.length);
                
                // Test immediato: prova a decodificare quello che hai appena creato
                console.log("üß™ Test immediato del codice generato...");
                try {
                    const testBinary = hexCode.match(/.{2}/g).map(hex => String.fromCharCode(parseInt(hex, 16))).join('');
                    const testDecoded = atob(testBinary);
                    const testJSON = decodeURIComponent(testDecoded);
                    const testParsed = JSON.parse(testJSON);
                    
                    if (testParsed.gameId === gameState.gameId) {
                        console.log("‚úÖ Test decodifica: SUCCESSO");
                    } else {
                        console.log("‚ùå Test decodifica: FALLITO - gameId non corrispondente");
                    }
                } catch (testError) {
                    console.log("‚ùå Test decodifica: FALLITO -", testError.message);
                }
                
                document.getElementById('save-code-display').textContent = hexCode;
                document.getElementById('save-modal').style.display = 'flex';
                
                console.log("‚úÖ Codice mostrato nel modal");
                
            } catch (error) {
                console.error("‚ùå Errore generazione:", error.message);
                showResult("Errore durante la generazione del codice di salvataggio!", 'error');
            }
        }
        
        function copySaveCode() {
            const code = document.getElementById('save-code-display').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showResult("Codice copiato negli appunti!", 'success');
            });
        }
        
        function loadGame() {
            document.getElementById('load-modal').style.display = 'flex';
        }
        
        function loadFromCode() {
            const hexCode = document.getElementById('load-code-input').value.trim();
            
            try {
                const binaryString = hexCode.match(/.{2}/g).map(hex => String.fromCharCode(parseInt(hex, 16))).join('');
                const jsonString = atob(binaryString);
                const saveData = JSON.parse(jsonString);
                
                if (saveData.gameId && saveData.player && saveData.inventory !== undefined) {
                    gameState = saveData;
                    if (gameState.fontSizeLevel) {
                        changeFontSize(0); // Applica il font size salvato
                    }
                    calculateCurrentWeight();
                    updateUI();
                    closeModal('load-modal');
                    showResult("Partita caricata con successo!", 'success');
                } else {
                    throw new Error("Dati non validi");
                }
            } catch (e) {
                showResult("Codice non valido!", 'error');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Inizializza il gioco
        calculateCurrentWeight();
        updateUI();
        showResult("üé£ Benvenuto nel Retro Fishing Quest! Inizia a pescare per guadagnare esperienza e monete.", 'info');
    </script>
</body>
</html>